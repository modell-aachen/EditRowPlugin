(function($){$.editable.addInputType("datepicker",{element:function(settings,original){var input=$("<input>");if(settings.width!="none"){input.width(settings.width)}if(settings.height!="none"){input.height(settings.height)}input.attr("autocomplete","off");$(this).append(input);return(input)},plugin:function(settings,original){var form=this;settings.onblur="ignore";$(this).find("input").datepicker({firstDay:1,dateFormat:$.datepicker.W3C,closeText:"X",onSelect:function(dateText){$(this).hide();$(form).trigger("submit")},onClose:function(dateText){original.reset.apply(form,[settings,original]);$(original).addClass(settings.cssdecoration)},})}});$.editable.addInputType("radio",{element:function(settings,original){var hinput=$('<input type="hidden" id="'+settings.name+'" name="'+settings.name+'" value="" />');$(this).append(hinput);var key,input,checked,id,cnt=1;for(key in settings.data){id=settings.name+"_button"+cnt;$(this).append('<label for="'+id+'">'+settings.data[key]+"</label>");checked=(key===settings.text)?' checked="checked"':"";input=$('<input type="radio" name="'+settings.name+'_buttons" id="'+id+'"'+checked+' value="'+key+'" />');$(this).append(input);input.click(function(){$("#"+settings.name).val($(this).val())});cnt++}return hinput}});$.editable.addInputType("checkbox",{element:function(settings,original){var hinput=$('<input type="hidden" id="'+settings.name+'" name="'+settings.name+'" value="" />');$(this).append(hinput);var key,input,checked,id,cnt=1;var picked=new RegExp("\\b("+settings.text.replace(/\s*,\s*/,"|")+")\\b");for(key in settings.data){id=settings.name+"_button"+cnt;checked=picked.test(key)?' checked="checked"':"";input=$('<input type="checkbox" name="'+settings.name+'_buttons" id="'+id+'"'+checked+' value="'+key+'" />');$(this).append(input);$(this).append('<label for="'+id+'">'+settings.data[key]+"</label>");input.change(function(){var vs='input[name="'+settings.name+'_buttons"]';var vals=[];$(vs).each(function(i,e){if($(e).attr("checked")){vals.push($(e).val())}});$("#"+settings.name).val(vals.join(","))});cnt++}return hinput}});$.fn.myMeta=function(){var oc=$(this).attr("class");var m=/({.*})/.exec(this.attr("class"));if(!m){return null}return eval("("+m[1]+")")};var setMetadata=function(e,keys,v){var obj=$(e).myMeta();var i,fld=obj;for(i=0;i<keys.length-1;i++){fld=fld[keys[i]]}fld[keys[keys.length-1]]=v;var oc=$(e).attr("class");$(e).attr("class",oc.replace(/{.*}/,$.toJSON(obj)))};var makeDraggable=function(tr){var dragee,container,rows;var onDrop=function(event,ui){var target=$(this);var edge;if(target.hasClass("drag-helper")){var top=rows.first().offset().top;var posY=event.pageY-top;edge=(posY<(rows.last().offset().top()+rows.last().height()-top)/2)?"top":"bottom";if(edge=="top"){target=rows.first()}else{target=rows.last()}}else{var posY=event.pageY-target.offset().top;edge=(posY<target.height()/2)?"top":"bottom"}var old_pos=dragee.myMeta().erp_data.erp_active_row;var new_pos=target.myMeta().erp_data.erp_active_row;if(edge=="bottom"){new_pos++}if(new_pos==old_pos){return}dragee.fadeTo("slow",0);container.css("cursor","wait");var p=$(this).myMeta();p.erp_data.erp_action="moveRow";p.erp_data.old_pos=old_pos;p.erp_data.new_pos=new_pos;if(edge=="top"){dragee.insertBefore(target)}else{dragee.insertAfter(target)}$.ajax({url:p.url,type:"POST",data:p.erp_data,success:function(response){container.html(response);container.css("cursor","auto")},error:function(){dragee.fadeTo("fast",1);container.css("cursor","auto")}})};tr.draggable({containment:tr.closest("tbody,thead,table"),axis:"y",helper:function(event){var helper=$(event.target).closest("tr").clone();return $("<div><table></table></div>").find("table").append(helper.addClass("drag-helper")).end()},start:function(event,ui){dragee=$(this);dragee.fadeTo("fast",0.3);container=dragee.closest("table");rows=container.find(".editRowPluginRow");rows.not(dragee).not(".drag-helper").droppable({drop:onDrop})},stop:function(){dragee.fadeTo("fast",1)}})};$(document).ready(function(){var erp_rowDirty=false;$(".editRowPluginInput").livequery("change",function(){erp_rowDirty=true});$(".editRowPlugin_willDiscard").livequery("click",function(){if(erp_rowDirty){if(!confirm("This action will discard your changes.")){return false}}return true});$(".erp_submit").livequery("click",function(){var form=$(this).closest("form");if(form&&form.length>0){form[0].erp_action.value=$(this).attr("href");form.submit();return false}return true}).button();$(".editRowPluginSort").livequery("click",function(){var m=/{(.*)}/.exec($(this).attr("class"));var md={};if(m){md=eval("({"+m[1]+"})")}return sortTable(this,false,md.headrows,md.footrows)});$(".editRowPluginCell").livequery(function(){var tr=$(this).closest("tr");if(!tr.hasClass("ui-draggable")){makeDraggable(tr)}var p=$(this).myMeta();if(!p.type||p.type=="label"){return}if(!p.tooltip){p.tooltip="Click to edit..."}p.onblur="cancel";if(!tr.hasClass("editRowPluginRow")&&p.erp_data&&p.erp_data.erp_active_row){var m=/({.*})/.exec($(this).attr("class"));var metadata=m[1];tr.addClass("editRowPluginRow "+metadata)}p.submitdata=function(value,settings){var sd=$(this).myMeta().erp_data;sd.erp_action="saveCell";return sd};if(p.type=="text"||p.type=="textarea"){p.callback=function(value,settings){setMetadata($(this),["data"],value)}}$(this).editable(p.url,p)})})})(jQuery);